---
- name: Get server from configure
  set_fact:
    now_item: "{{ item }}"
  with_dict: "{{ rs_conf }}"
  when: inventory_hostname == item.key

- debug: "var=now_item"

- name: Create directory
  file: path={{ item }} state=directory mode=0777
  with_items:
    - "{{ ansible_env.HOME }}/opt/confile/mongodb/"
    - "{{ now_item.value.db_path }}"
  become: yes

- name: Copy key file for mongo
  copy: src=files/{{ item.src }} dest={{ ansible_env.HOME }}/opt/confile/{{ item.name }} mode={{ item.mode }}
  with_items:
    - { src: mongo-keyfile, name: mongo-keyfile , mode: "0600" }

- name: Create user for MongoDB
  include: create_user.yml

- name: Set varible to enable auth
  set_fact: 
    enable_service: true

- name: Render mongo replicat_set config 
  template: 
    src: mongod.conf.j2
    dest: "{{ ansible_env.HOME }}/opt/confile/mongod-{{ now_item.value.replica_name }}.conf"

- name: Start replica set for MongoDB to set user
  command: mongod --config  {{ ansible_env.HOME }}/opt/confile/mongod-{{ now_item.value.replica_name }}.conf

